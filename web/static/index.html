<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
</head>
<body>
  <h2>Raspberry PI Zero stock</h2>
  <div id="main">
    <div id="statusList">

    </div>
  </div>
  <p>Site under construction</p>
</body>
<script>
  function promiseMe(name) {
    var load = new Promise(function(resolve, reject) {
      $.ajax("/stock/"+name).success(function(status, val, res) {
        if(res.status == 202) {
          resolve({name: name , status: null});
        }
        resolve({name: name , status: status});
      });
    });
    return load;
  }
  $("#statusList").text("Loading...");

  var runPromises = function() {
    Promise.all([promiseMe("pimoroni"), promiseMe("pihut"), promiseMe("pisupply s")])
    .then(function(results) {
      console.log(results);
      var values = "";
      results.forEach(function(v) {
        if(!v.status) {
          values+="<li> Refreshing "+v.name+"</li>\n";
        } else {
          values+="<li> <b>"+v.name+ "</b> "+ (v.status.stock?"in stock":"out of stock")+"</li>\n";
        }
      });
      $("#statusList").html(values);
    })
    .catch(function(error) {
      $("#statusList").text("Error loading: "+ error);
    });
  };
  runPromises();

  setInterval(function() {
    runPromises();
  }, 1000);
</script>
</html>
